<!DOCTYPE html>
<html>
<head>
    <title>Vòng Quay May Mắn</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="main.css" type="text/css" />
    <link type="icon/x-icon" href="favicon.ico" rel="shortcut icon" />
    <script type="text/javascript" src="Winwheel.min.js"></script>
    <script src="TweenMax.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: url('hinhnen-pc.png') no-repeat center center fixed;
            background-size: cover;
        }

        /* Media query for tablets and small desktops */
        @media only screen and (max-width: 1200px) {
            body {
                background: url('hinhnen-tablet.png') no-repeat center center fixed;
                background-size: cover;
            }
        }

        /* Media query for mobile devices */
        @media only screen and (max-width: 768px) {
            body {
                background: url('hinhnen-mobile.png') no-repeat center center fixed;
                background-size: cover;
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 10px;
        }
        #userForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
        }
        .wheel-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        .pointer {
            position: absolute;
            top: 0;
            left: 50%;
            width: 35px;
            height: 50px;
            transform: translateX(-50%);
            z-index: 1;
        }
        .btn {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        input[type="text"], select {
            width: 150px;
            padding: 1px;
            font-size: 14px;
            margin: 5px 0;
        }
        .info-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <form id="userForm" onsubmit="startSpin(event);">
            <input type="text" id="invoice" name="invoice" placeholder="Hoá Đơn Mua Hàng" required minlength="8" maxlength="8" pattern=".{8}" title="Hoá đơn mua hàng phải có 8 ký tự">
            <select id="store" name="store" required>
                <option value="" disabled selected>Chọn Địa Chỉ Cửa Hàng</option>
                <option value="CN Vĩnh Trạch">CN Vĩnh Trạch</option>
                <option value="CN Cù Lao Dung">CN Cù Lao Dung</option>
                <option value="CN Lai Hoà">CN Lai Hoà</option>
                <option value="CN Vinh Phước">CN Vinh Phước</option>
                <option value="CN Khánh Hoà">CN Khánh Hoà</option>
                <option value="CN HòaTú">CN HòaTú</option>
                <option value="CN Vinh Châu">CN Vinh Châu</option>
                <option value="CN Gia Hoà">CN Gia Hoà</option>
                 <option value="CN Chợ Kinh">CN Chợ Kinh</option>
            </select>
            <button type="submit" id="spin_start" class="btn">Quay ngay</button>
        </form>
        <div class="wheel-container">
            <img src="pointer.png" alt="Pointer" class="pointer" />
            <canvas id="canvas" width="434" height="434">
                <p style="color: white" align="center">Sorry, your browser doesn't support canvas. Please try another.</p>
            </canvas>
            <audio id="backgroundAudio">
                <source src="background.mp3" type="audio/mpeg">
                <source src="background.mp3" type="audio/wav">
            </audio>
        </div>
    </div>
    <script>
        let duration = 5;
        let spins = 55;
        let theWheel = new Winwheel({
            'numSegments': 10,  // Số ô được chia thành 10
            'outerRadius': 212,
            'textFontSize': 18,
            'rotationAngle': 0,
            'segments': [
                {'fillStyle': '#ffffff', 'text': 'SULFATRIME'},        // Ô 1
                {'fillStyle': '#fb6700', 'text': 'ÁO MƯA'},            // Ô 2
                {'fillStyle': '#ffffff', 'text': 'AQUA YUCCA ZEO C'},  // Ô 3
                {'fillStyle': '#fb6700', 'text': 'BZT DIGESTER'},      // Ô 4
                {'fillStyle': '#ffffff', 'text': 'C PLUS'},            // Ô 5
                {'fillStyle': '#fb6700', 'text': 'PREMIX 9999'},       // Ô 6
                {'fillStyle': '#ffffff', 'text': 'POND BACILUSS'},     // Ô 7
                {'fillStyle': '#fb6700', 'text': 'SCANVIRON'},         // Ô 8
                {'fillStyle': '#ffffff', 'text': 'AQUA BZT (227g)'},   // Ô 9
                {'fillStyle': '#fb6700', 'text': 'EDTA THIO 2X'},      // Ô 10
            ],
            'animation': {
                'type': 'spinToStop',
                'duration': duration,
                'spins': spins,
                'callbackSound': playSound,
                'soundTrigger': 'pin',
                'callbackFinished': alertPrize,
            },
            'pins': {
                'number': 32
            }
        });

        let wheelSpinning = false;

        let audio = document.getElementById('backgroundAudio');
        let tickSound = new Audio('tick.mp3');

        function playSound() {
            tickSound.pause();
            tickSound.currentTime = 0;
            tickSound.play();
        }

        function startSpin(event) {
            event.preventDefault();

            if (!wheelSpinning) {
                const invoice = document.getElementById('invoice').value;
                const store = document.getElementById('store').value;

                if (invoice && invoice.length === 8 && store) {
                    document.getElementById('spin_start').setAttribute("disabled", true);
                    stopAngle();
                    theWheel.startAnimation();
                    wheelSpinning = true;
                    // Play background audio
                    audio.play();
                } else {
                    alert("Vui lòng nhập hoá đơn mua hàng gồm 8 ký tự và chọn địa chỉ cửa hàng!");
                }
            }

        }

        function stopAngle() {
            let probability = Math.random();
            let stopAt;

            // Chia góc thành các phần tương ứng với xác suất
            if (probability < 0.50) { // 50% cho ô 1
                let start = 0;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else if (probability < 0.60) { // 10% cho ô 2
                let start = 36;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else if (probability < 0.70) { // 10% cho ô 3
                let start = 72;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else if (probability < 0.75) { // 5% cho ô 4
                let start = 108;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else if (probability < 0.80) { // 5% cho ô 5
                let start = 144;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else if (probability < 0.85) { // 5% cho ô 6
                let start = 180;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else if (probability < 0.90) { // 5% cho ô 8
                let start = 252;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else if (probability < 0.95) { // 5% cho ô 9
                let start = 288;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            } else { // 5% cho ô 10
                let start = 324;
                let stop = Math.floor(Math.random() * 36);
                stopAt = start + stop;
            }

            // Đảm bảo góc không rơi vào khoảng của ô 7 (216 đến 252 độ)
            let segment7Start = 216;
            let segment7End = 252;
            if (stopAt >= segment7Start && stopAt < segment7End) {
                stopAt = (segment7End + 1 + Math.floor(Math.random() * (360 - segment7End))) % 360;
            }

            theWheel.animation.stopAngle = stopAt;
        }

        function alertPrize(indicatedSegment) {
            const invoice = document.getElementById('invoice').value;
            const store = document.getElementById('store').value;

            fetch('https://script.google.com/macros/s/AKfycbwzx4tw7B3QfVvWlnLl2AK4pl-mtmXSNdotidWDs2fOAGvE9dqcmziEGHJ2jHQRdbCI/exec' + '?invoice=' + invoice + '&store=' + store + '&indicatedSegment=' + encodeURIComponent(indicatedSegment.text))
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    alert("Bạn đã trúng: " + indicatedSegment.text);
                    wheelSpinning = false;
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
